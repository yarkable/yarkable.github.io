---
layout: post
title: æ¨¡å‹éƒ¨ç½²ä»0åˆ°1
subtitle: 
date: 2021-12-10
author: kevin
header-img: img/green-bg.jpg
catalog: true
tags:
    - troubleshoot
    - linux
    - python
    - model deployment
    - onnx
    - pytorch
    - deep learning

---



## preface



ç”±äºé¡¹ç›®éœ€è¦ï¼Œkevin è¦å°†æ¨¡å‹æ”¾åˆ°æ‰‹æœºé‡Œé¢å»æµ‹è¯•é€Ÿåº¦ï¼Œäºæ˜¯ä¹å†™äº†è¿™ç¯‡æ–‡ç« ï¼Œè®°å½•è¿™ä¸ªè¿‡ç¨‹ã€‚æœ¬æ¥æƒ³å°è¯• ncnn è¿›è¡Œéƒ¨ç½²ï¼Œç„¶è€Œæµç¨‹æœ‰äº›å¤æ‚ï¼Œäºæ˜¯ä¹åœ¨å¸ˆå…„çš„å»ºè®®ä¸‹å…ˆç”¨ PyTorch å®˜æ–¹çš„ [Mobile æ¨¡å—](https://pytorch.org/mobile/android/)è¯•è¯•ï¼ŒGitHub ä»“åº“é‡Œé¢æœ‰å¾ˆå¤šè¯¦ç»†çš„ demo å±•ç¤ºï¼Œç›´æ¥ clone ä¸‹æ¥å°±è¡Œäº†ã€‚



## è£…åŒ…é…ç¯å¢ƒ



ä¼—æ‰€å‘¨çŸ¥ï¼Œå°†æ¨¡å‹æ”¾åˆ°æ‰‹æœºä¸­å»æµ‹è¯•é€Ÿåº¦çš„è¯å‘¢ï¼Œè‚¯å®šå¾—å…ˆæä¸ª APP å‡ºæ¥ï¼Œç›®å‰æœ‰å®‰å“å¼€å‘å’Œ IOS å¼€å‘ï¼Œæ¯”è¾ƒæ™®éçš„æ˜¯å®‰å“å¼€å‘ï¼Œå› ä¸ºå¯ä»¥ç”¨ JAVA ä½œä¸ºå¼€å‘è¯­è¨€ï¼ŒIOS å¼€å‘çš„è¯è¿˜éœ€è¦ä¸€ä¸ª MAC ç¬”è®°æœ¬æ‰èƒ½åšè¿™äº‹ï¼Œé‡‘é’±é—¨æ§›æ¯”è¾ƒé«˜ï¼Œå¹¶ä¸”ç”¨çš„ä¹Ÿæ˜¯ Swift è¯­è¨€ï¼Œå—ä¼—æ¯”è¾ƒå°‘ã€‚è¿™é‡Œæˆ‘ä»¬é€‰æ‹© Android åº”ç”¨ã€‚é¦–å…ˆç›´æ¥å®‰è£… Android Studioï¼Œå®‰è£…çš„è¿‡ç¨‹å¾ˆçœäº‹ï¼Œå¹¶ä¸”ä¼šå°†å®‰å“å¼€å‘éœ€è¦çš„ä¸¤ä¸ªç¯å¢ƒï¼š SDK å’Œ NDK éƒ½å®‰è£…å¥½ã€‚ä¸è¿‡å¾—çœ‹ç½‘ç»œå¿«ä¸å¿«ï¼Œæ¯•ç«Ÿä¸‹è½½çš„åº“éƒ½åœ¨å›½å¤–ï¼Œå¯èƒ½ä¼šå‡ºç°é”™è¯¯ã€‚



ä¸‹è½½å®Œä¹‹åå°±å¯¼å…¥é¡¹ç›®ï¼Œ PyTorch å®˜æ–¹æä¾›äº†æ•™ç¨‹åˆé›†ï¼Œé“¾æ¥åœ¨ä¸‹é¢ï¼Œkevin ä½¿ç”¨äº† PyTorchDemoApp è¿™ä¸ªé¡¹ç›®è¿›è¡Œæ“ä½œã€‚

```
https://github.com/pytorch/android-demo-app.git
```



**åœ¨ Gradle æ–‡ä»¶å¤¹ä¸­æœ‰ä¸ª `gradle_wrapper.properties` æ–‡ä»¶**ï¼Œä¼¼ä¹æ¯æ¬¡å¯¼å…¥é¡¹ç›®éƒ½ä¼šæ ¹æ®é‡Œé¢æåˆ° gradle çš„ç‰ˆæœ¬å»ä¸‹è½½ gradleï¼Œå¤§å¤§æ‹–æ…¢æ—¶é—´ï¼Œåç»­å°è¯•ä¸€ä¸‹æŠŠé‡Œé¢çš„  `distributionUrl` ç»™æ³¨é‡Šæ‰ (ä¸èƒ½æ³¨é‡Šï¼Œå»ºè®®æ”¹æˆä½ä¸€ç‚¹èƒ½æˆåŠŸç¼–è¯‘çš„ç‰ˆæœ¬)

```properties
#Thu Nov 19 15:33:02 PST 2020
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
# distributionUrl=https\://services.gradle.org/distributions/gradle-6.1.1-all.zip
```





æŒ‰ç…§ç½‘ä¸Šçš„æ•™ç¨‹æ¥è¯´çš„è¯ï¼Œç›´æ¥ç‚¹å‡»ç»¿è‰²çš„é”¤å­å¼€å§‹ç¼–è¯‘ï¼Œç„¶åå°†æ‰‹æœºé€šè¿‡ USB çº¿è¿æ¥åˆ°ç”µè„‘ä¹‹åç‚¹å‡»ç»¿è‰²ä¸‰è§’å½¢å°±å¯ä»¥åœ¨çœŸæœºä¸Šè¿›è¡Œæ“ä½œäº†ï¼Œç„¶åè¿™äº›æ•™ç¨‹å°±æ²¡æœ‰åç»­äº†ï¼Œå¤§æ¦‚ç‡éƒ½æ˜¯æŠ„æ¥æŠ„å»çš„ï¼Œkevin åœ¨æçš„æ—¶å€™å°±é‡åˆ°äº†å¾ˆå¤šçš„éº»çƒ¦ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šæˆ‘çš„ç»¿è‰²é”¤å­æ˜¯ç°è‰²çš„ã€‚



![1](https://s2.loli.net/2021/12/10/rEvFnG2qAbawRMs.png)



å¤§å¤šæ•°éº»çƒ¦éƒ½æ¥è‡ªé…ç½® Android Studio ç¯å¢ƒï¼Œå„ç§æŠ¥é”™ã€‚é…ç½® Android Studio çš„å…·ä½“æ­¥éª¤æˆ‘å·²ç»è®°ä¸èµ·æ¥äº†ï¼Œè¿™é‡Œè¯´å‡ ä¸ªæˆ‘è¿˜è®°å¾—çš„é”™è¯¯ï¼ˆæ€ªä¸å¾—ç½‘ä¸Šçš„æ•™ç¨‹åˆ°è¿™ä¸€æ­¥ç›´æ¥å°±è·³è¿‡äº†ï¼Œå› ä¸º Android Studio çš„ç¯å¢ƒç¡®å®éš¾æï¼Œå¾ˆå¤šå†™åšå®¢çš„æˆ‘ä¼°è®¡ä»–è‡ªå·±å‹æ ¹æ²¡æœ‰è‡ªå·±å°è¯•è¿‡è¿™ä¸€æ­¥å°±çå‡ æŠŠå†™ï¼‰ã€‚



é¦–å…ˆï¼ŒGradle è¿™ä¸ªä¸œè¥¿åº”è¯¥æ˜¯ AS é‡Œé¢çš„ä¸€ç§æ’ä»¶ä¹‹ç±»çš„å§ï¼Œæˆ‘å‘ç°æ¯æ¬¡æ–°å»ºä¸€ä¸ªé¡¹ç›®ä»–éƒ½ä¼šç»™æˆ‘é‡æ–°ä¸‹è½½ä¸€ä¸ª Gradleï¼Œæˆ‘æš‚æ—¶ä¸çŸ¥é“è¿™æ˜¯åœ¨å¹²ä»€ä¹ˆçš„ï¼Œæ¯”è¾ƒé‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬çš„ Gradle çš„ç‰ˆæœ¬æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œæœ‰äº›ç‰ˆæœ¬æ˜¯ä¸å…¼å®¹çš„ï¼Œæèµ·æ¥å°±éå¸¸éº»çƒ¦ã€‚æ¯ä¸€ä¸ªé¡¹ç›®éƒ½æœ‰ä¸¤ä¸ª `build.gradle` æ–‡ä»¶ï¼Œä¸€ä¸ªåœ¨æ ¹ç›®å½•ï¼Œä¸€ä¸ªåœ¨ app æ–‡ä»¶å¤¹é‡Œé¢ã€‚æˆ‘ä»¬ä¸€èˆ¬è¦æ›´æ”¹çš„æ˜¯æ ¹ç›®å½•ä¸‹çš„ `build.gradle`ã€‚AS è‡ªå·±ä¸‹è½½å¥½ Gradle ä¹‹åï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸Šæ–¹çš„é”¤å­å°±ä¼šå˜ç»¿ï¼Œå¹¶ä¸”ä¼šæœ‰ä¸€ä¸ªå®‰å“å›¾æ ‡çš„ `app` é…ç½®åœ¨å³è¾¹ã€‚ä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ç›´æ¥ç¼–è¯‘çš„è¯æ˜¯ä¼šæŠ¥é”™çš„ï¼Œä¼šè¯´ç±»ä¼¼å¦‚ä¸‹çš„ä¸œè¥¿ã€‚

```
Minimum supported Gradle version is 6.1.1. Current version is 5.6.2.
```



ç»è¿‡ä¸€ç•ªå¿ƒæ€çˆ†ç‚¸ä¹‹åæˆ‘æ‰çŸ¥é“ Android Gradle æ’ä»¶ä¸ Gradle ç‰ˆæœ¬æ˜¯æœ‰å¯¹åº”å…³ç³»çš„ï¼Œæˆ‘ä»¬å¾—ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„æ’ä»¶ï¼Ÿä¸ç„¶ä¼šæŠ¥é”™ï¼ŒCNM

| AS ä¸­ Gradle æ’ä»¶ç‰ˆæœ¬ | æ‰€éœ€çš„ Gradle ç‰ˆæœ¬ |
| :-------------------- | :----------------- |
| 1.0.0 - 1.1.3         | 2.2.1 - 2.3        |
| 1.2.0 - 1.3.1         | 2.2.1 - 2.9        |
| 1.5.0                 | 2.2.1 - 2.13       |
| 2.0.0 - 2.1.2         | 2.10 - 2.13        |
| 2.1.3 - 2.2.3         | 2.14.1+            |
| 2.3.0+                | 3.3+               |
| 3.0.0+                | 4.1+               |
| 3.1.0+                | 4.4+               |
| 3.2.0 - 3.2.1         | 4.6+               |
| 3.3.0 - 3.3.3         | 4.10.1+            |
| 3.4.0 - 3.4.3         | 5.1.1+             |
| 3.5.0 - 3.5.4         | 5.4.1+             |
| 3.6.0 - 3.6.4         | 5.6.4+             |
| 4.0.0+                | 6.1.1+             |
| 4.1.0+                | 6.5+               |



æˆ‘ä»¬å¯ä»¥åœ¨ `File - Project Structure` é‡Œé¢çœ‹çœ‹æˆ‘ä»¬çš„é…ç½®ï¼Œè·Ÿä¸Šé¢çš„è¡¨ä¸å¯¹åº”çš„è¯å°±è¯´æ˜æˆ‘ä»¬è¦æ”¹ä¸€ä¸‹è¿™ä¸ªä¸œè¥¿

![image.png](https://s2.loli.net/2021/12/10/jZ8MpR1Dxuyb5SO.png)



é‚£ä¹ˆåœ¨å“ªé‡Œæ”¹å‘¢ï¼Œåœ¨æ ¹ç›®å½•ä¸‹çš„ `build.gradle` é‡Œé¢æ”¹ï¼Œæ”¹å®Œä¹‹åé‡æ–°ç¼–è¯‘ä¸€ä¸‹ï¼Œä¸å‡ºæ„å¤–çš„è¯åˆä¼šå‡ºé”™ï¼Œæ¥ä¸‹å»æˆ‘ä»¬çœ‹çœ‹åˆå‡ºäº†ä»€ä¹ˆå‹¾å…«é—®é¢˜

```gradle
    dependencies {
        classpath 'com.android.tools.build:gradle:3.5.2' // è‰ä»–ğŸçš„æ¯”ï¼Œè¿™é‡Œçš„æ’ä»¶ç‰ˆæœ¬è·Ÿç¯å¢ƒé‡Œçš„ç‰ˆæœ¬ä¸ä¸€æ ·
    }
```



è¿™ä¸‹æŠ¥çš„æ˜¯è¿™ä¸ªé”™

```
No toolchains found in the NDK toolchains folder for ABI with prefix: arm-linux-androideabi
```



å­—é¢æ„æ€ï¼Œè¯´æˆ‘ä»¬çš„ NDK ç¼ºå°‘äº†ä¸€ä¸ªç¼–è¯‘é“¾å·¥å…·ï¼Œç„¶åå»æ‰¾çš„æ—¶å€™å‘ç°æ˜¯å­˜åœ¨çš„ï¼Œå¹¶æ²¡æœ‰ç¼ºå°‘ï¼Œåˆæ˜¯ä¸€é€šå¿ƒæ€çˆ†ç‚¸ä¹‹åæˆ‘åœ¨ StackOverflow æ‰¾åˆ°ä¸€ä¸ªç­”æ¡ˆï¼Œè¯´æ˜¯ NDK ç‰ˆæœ¬å¤ªé«˜äº†ï¼Œéœ€è¦é™æˆä½ç‰ˆæœ¬çš„å°±è¡Œäº†ï¼Œæˆ‘çœ‹äº†ä¸€ä¸‹æˆ‘çš„ç‰ˆæœ¬æ˜¯ 23.x çš„ï¼Œé‡æ–°åœ¨ AS é‡Œé¢å®‰è£…äº†ä¸€ä¸ª 20.x çš„ï¼ˆæœ€å¥½åœ¨ AS é‡Œé¢å®‰è£…ï¼Œä¸è¦è‡ªå·±è£…ï¼Œåˆ°æ—¶å€™è¿˜è¦è§£å‹ä¹‹ç±»çš„å¾ˆéº»çƒ¦ï¼‰ï¼ŒæŒ‰ç…§æˆ‘ä¸‹é¢ç»™çš„æ­¥éª¤å°±å¯ä»¥é‡è£…äº†ï¼Œå¤§æ¦‚ååˆ†é’Ÿå·¦å³

![image.png](https://s2.loli.net/2021/12/10/iyjDvtSHpbCd2s7.png)



ç„¶åæˆ‘ä»¬éœ€è¦å» `Project Structure` é‡Œé¢é…ç½® NDK çš„è·¯å¾„ï¼Œä½¿æ”¹åŠ¨ç”Ÿæ•ˆã€‚

![image.png](https://s2.loli.net/2021/12/10/fuNKhx9l61dLstQ.png)



å¦‚æœ SDK å’Œ NDK éƒ½è£…å¥½çš„è¯åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `local.properties` ä¸­å°±ä¼šå‡ºç°å…·ä½“çš„è·¯å¾„

```properties
sdk.dir=C\:\\Users\\kevin\\AppData\\Local\\Android\\Sdk
ndk.dir=C\:\\Users\\kevin\\AppData\\Local\\Android\\Sdk\\ndk\\20.1.5948944
```



ç„¶åå†æ¬¡ç‚¹å‡»ç»¿è‰²å°é”¤å­è¿›è¡Œç¼–è¯‘ï¼ŒTMDï¼ŒæˆåŠŸç¼–è¯‘ï¼ï¼ï¼



ç„¶åå°†æ‰‹æœºè¿åˆ°ç”µè„‘ï¼Œè°ƒæˆå¼€å‘è€…æ¨¡å¼ï¼Œæ‰“å¼€ USB è°ƒè¯•å¼€å…³ï¼ŒAS å°±èƒ½å¤Ÿè¯†åˆ«åˆ°è®¾å¤‡äº†ï¼Œç„¶åç‚¹å‡»ç»¿è‰²ä¸‰è§’å½¢è¿›è¡Œæ‰“åŒ…ï¼ŒæˆåŠŸçš„è¯ç¼–è¯‘å®Œçš„ apk å°†ä¼šå¯¼å…¥åˆ°æ‰‹æœºä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å®‰è£…å°±è¡Œäº†ï¼Œä½†æ˜¯åˆå‡ºé”™äº†ï¼Œå…·ä½“å¿˜äº†ï¼Œä½†æ˜¯æ˜¯ä¸€ä¸ª NDK çš„é”™è¯¯ï¼Œä½†æ˜¯æ˜æ˜æˆ‘ä»¬å·²ç»å®‰è£…äº†æ­£ç¡®çš„ NDK äº†ï¼Œè¿™æ—¶ kevin åˆé€šè¿‡ Google æ‰¾åˆ°äº†ç­”æ¡ˆï¼Œæˆ‘ä»¬è¿™æ¬¡è¦æ”¹ `app/build.gradle`ï¼Œå°†é‡Œé¢çš„ NDK ç‰ˆæœ¬æ”¹æˆæˆ‘ä»¬çš„ç‰ˆæœ¬

```
android {
	...
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
    ndkVersion '20.1.5948944'
}
```



ç„¶åï¼Œç»ˆäº OK äº†ï¼Œå®˜æ–¹ demo åˆ°æ­¤å°±å¯ä»¥åœ¨æ‰‹æœºä¸Šè¿è¡Œäº†ï¼Œç¬¬ä¸€æ­¥å¤§åŠŸå‘Šæˆï¼





## é€šè¿‡åˆ†å‰² demo ä»‹ç»éƒ¨ç½²



æŒ‰ç…§æ•™ç¨‹ç›´æ¥ä¸‹è½½æƒé‡çš„è¯ä¼šå‡ºç°é—®é¢˜ `file bytecode.pkl: file not found ()` ï¼Œæ¨¡å‹åœ¨ Netron é‡Œé¢ä¹Ÿæ‰“ä¸å¼€ï¼Œåæ¥åœ¨å®˜ç½‘ä¸Šå‘ç°å’±ä»¬è¿˜å°‘äº†ä¸€ä¸ªæ­¥éª¤

> If you see the error message: PytorchStreamReader failed locating file bytecode.pkl: file not found (), likely you are using a torch script model that requires the use of the PyTorch JIT interpreter (a version of our PyTorch interpreter that is not as size-efficient). In order to leverage our efficient interpreter, please regenerate the model by running: module._save_for_lite_interpreter(${model_path}).
>
> - If bytecode.pkl is missing, likely the model is generated with the api: module.save(${model_psth}).
> - The api _load_for_lite_interpreter(${model_psth}) can be helpful to validate model with the efficient mobile interpreter.



ä»–è¯´æˆ‘ä»¬è¿™ä¸ªæ˜¯ TorchScript æ¨¡å‹ï¼Œè¿˜è¦é’ˆå¯¹ç§»åŠ¨ç«¯è¿›è¡Œä¼˜åŒ–ï¼Œå½³äºï¼Œé‚£æˆ‘å°±ç»§ç»­å¾€ä¸‹èµ°ï¼Œæ ¹æ®å®˜æ–¹ä»£ç å†²

```python
import torch
from torch.utils.mobile_optimizer import optimize_for_mobile
model = torch.jit.script('deeplabv3_scripted.pt')

optimized_scripted_module = optimize_for_mobile(scripted_module)
optimized_scripted_module._save_for_lite_interpreter("deeplabv3_scripted.ptl")
```



ç„¶ååˆæŠ¥é”™äº†ï¼Œè¯´ä»€ä¹ˆ `Objects is bot supported ...` ï¼Œåæ¥åˆæ˜¯ä¸€ç•ªæŸ¥æ‰¾ï¼Œå‘ç°è¿™ä¸ªæ¨¡å‹å¯èƒ½æ˜¯ç”¨é«˜ç‰ˆæœ¬çš„ PyTorch è®­ç»ƒå‡ºæ¥çš„ï¼Œä¸å…¼å®¹ï¼Œäºæ˜¯æˆ‘åˆå°†æˆ‘çš„ PyTorch å‡çº§åˆ°äº†æœ€æ–°çš„ 0.10.0 ç‰ˆæœ¬ï¼Œè¿™æ¬¡å°±å¯ä»¥äº†ï¼Œæœ€ç»ˆä¼šåœ¨æ ¹ç›®å½•ç”Ÿæˆä¸‰ä¸ªæ¨¡å‹ï¼Œæˆ‘ä»¬è¦çš„æ˜¯æœ€åä¸€ä¸ªç»è¿‡ä¼˜åŒ–è¿‡çš„æ¨¡å‹

![models](https://s2.loli.net/2021/12/11/Hps57RqYN13OwFK.png)



ç„¶åå°±å¯ä»¥äº†ï¼ä¹‹å‰ä¸€ç›´æ˜¯å› ä¸ºæ¨¡å‹çš„é—®é¢˜å¯¼è‡´ä¸€æ‰“å¼€åº”ç”¨å°±é—ªé€€ï¼Œè¿˜å¥½ AS çœ‹æ—¥å¿—ä¹Ÿæ¯”è¾ƒæ–¹ä¾¿ï¼Œé€šè¿‡ `Log.e(msg)` è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œç„¶åæˆ‘ä»¬åœ¨ä¸‹æ–¹çš„è§†çª—ä¸­å°±å¯ä»¥å®šä½åˆ°æ˜¯ä»€ä¹ˆé”™è¯¯äº†

![error](https://s2.loli.net/2021/12/11/Tk1GyfqcV8v3jLi.png)



ç„¶åå‘ç°å®˜æ–¹çš„ä¾‹å­ä¸­å·²ç»å¯¹æ­¥éª¤éƒ½è®²çš„ç‰¹åˆ«è¯¦ç»†äº†ï¼Œæˆ‘å°±ä¸å†è„±è£¤å­æ”¾å±äº†ï¼Œå»ºè®®ç›´æ¥çœ‹[å®˜æ–¹çš„æ•™ç¨‹](https://pytorch.org/mobile/android/#custom-build)ï¼Œæˆ‘åœ¨è¿™é‡Œç®€å•è®²ä¸€ä¸‹ AS å¼€å‘é¡¹ç›®çš„ä¸€ä¸ªä¸»è¦æ¨¡å—ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¸œè¥¿éƒ½åœ¨ `app` æ–‡ä»¶å¤¹ä¸­å†™ï¼Œç¼–è¯‘æˆåŠŸä¹‹åä¼šç”Ÿæˆä¸€ä¸ª `build` æ–‡ä»¶å¤¹ï¼Œé‡Œé¢æ”¾ç½®äº†ç¼–è¯‘æ–‡ä»¶ä»¥åŠç”Ÿæˆçš„ apk æ–‡ä»¶ã€‚`src` é‡Œé¢æ˜¯æˆ‘ä»¬çš„ä¸»è¦ä»£ç ä¸é€»è¾‘ï¼Œ`main/assets` é‡Œé¢è£…ç€éœ€è¦ç”¨åˆ°çš„ç´ æï¼Œ`main/java` é‡Œé¢æ˜¯ä¸»è¦æ§åˆ¶ä»£ç ï¼Œæ˜¯ç”¨ JAVA å†™çš„ï¼Œæˆ‘ä»¬éœ€è¦åœ¨é‡Œé¢å®ç°æ‰€æœ‰çš„åŠŸèƒ½ã€‚ `main/res` é‡Œé¢æ˜¯ä¸€äº›å¸ƒå±€ä¹‹ç±»çš„ï¼Œ`layout` é‡Œé¢æ˜¯æ•´ä¸ª UIï¼Œç‚¹è¿›å»çš„è¯ä¼šå‡ºç° QT designer ä¸€æ ·çš„æ§ä»¶é¡µé¢ï¼Œå¯ä»¥æ‹–æ‹½ï¼Œå…¶ä»–çš„æ²¡å•¥è®²çš„ï¼Œæˆ‘ä»¬ä¸»è¦æ˜¯çœ‹ `main/java` é‡Œé¢çš„ä»£ç 

```
.
â”œâ”€â”€ app
â”‚Â Â  â”œâ”€â”€ build
â”‚Â Â  â””â”€â”€ src
â”‚Â Â      â””â”€â”€ main
â”‚Â Â          â”œâ”€â”€ assets
â”‚Â Â          â”œâ”€â”€ java
â”‚Â Â          â”‚Â Â  â””â”€â”€ org
â”‚Â Â          â”‚Â Â      â””â”€â”€ pytorch
â”‚Â Â          â”‚Â Â          â””â”€â”€ imagesegmentation
â”‚Â Â          â””â”€â”€ res
â”‚Â Â              â”œâ”€â”€ drawable
â”‚Â Â              â”œâ”€â”€ drawable-v24
â”‚Â Â              â”œâ”€â”€ layout
â”‚Â Â              â”œâ”€â”€ mipmap-hdpi
â”‚Â Â              â”œâ”€â”€ mipmap-mdpi
â”‚Â Â              â”œâ”€â”€ mipmap-xhdpi
â”‚Â Â              â”œâ”€â”€ mipmap-xxhdpi
â”‚Â Â              â”œâ”€â”€ mipmap-xxxhdpi
â”‚Â Â              â””â”€â”€ values
â””â”€â”€ gradle
```



ç”±äºå®˜æ–¹è®²çš„å¾ˆè¯¦ç»†äº†ï¼Œæˆ‘è¿™é‡Œå°±åªè®°å½•ä¸€ä¸‹ä¸€äº›ä¸»è¦å‡½æ•°ï¼Œä¸ç®¡æ˜¯ä¸æ˜¯ç§»åŠ¨ç«¯ï¼Œæ¨ç†éƒ½è¦è¿›è¡Œä¸‹é¢è¿™äº›æ­¥éª¤ï¼Œåªä¸è¿‡è¿™é‡Œç”¨çš„æ˜¯ JAVA å®ç°

```java
Bitmap bitmap = BitmapFactory.decodeStream(getAssets().open("image.jpg"));	// è¯»å–ç´ æ
Bitmap bitmap = BitmapFactory.decodeStream(getAssets().open("image.jpg"));	// å¯¼å…¥æ¨¡å‹
Tensor inputTensor = TensorImageUtils.bitmapToFloat32Tensor(bitmap,
    TensorImageUtils.TORCHVISION_NORM_MEAN_RGB, TensorImageUtils.TORCHVISION_NORM_STD_RGB);	// é¢„å¤„ç†å›¾ç‰‡
Tensor outputTensor = module.forward(IValue.from(inputTensor)).toTensor();	// å‰å‘æ¨ç†
float[] scores = outputTensor.getDataAsFloatArray();	// å¾—åˆ°ç»“æœ

float maxScore = -Float.MAX_VALUE;
int maxScoreIdx = -1;
for (int i = 0; i < scores.length; i++) {
  if (scores[i] > maxScore) {
    maxScore = scores[i];
    maxScoreIdx = i;
  }
}
String className = ImageNetClasses.IMAGENET_CLASSES[maxScoreIdx];	// å¤„ç†ç»“æœ
```



## Android Studio ä¸€äº›ç®€å•çŸ¥è¯†ç‚¹



APP æ‰“å¼€æ—¶è¿è¡Œçš„ç¬¬ä¸€ä¸ªå…¥å£ç¨‹åºå°±æ˜¯ `onCreate`ï¼Œç±»ä¼¼ main å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡ç‚¹çœ‹è¿™ä¸ªå‡½æ•°å¹²äº†å•¥ã€‚

---



å½“ implements äº† Runnable çš„è¯ï¼Œéœ€è¦åœ¨ç±»é‡Œé¢é‡è½½ä¸€ä¸ª run() å‡½æ•°ï¼Œè¿™æ ·å®ç° Runnable è¿™ä¸ªç±»çš„è¯å¯ä»¥æ–¹ä¾¿åˆ›å»ºçº¿ç¨‹ï¼Œè¿™æ˜¯ JAVA çŸ¥è¯†ã€‚

```java
public class MainActivity extends AppCompatActivity implements Runnable{
   
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        mButtonSegment.setOnClickListener(new View.OnClickListener() {
            public void onClick(View v) {
                mButtonSegment.setEnabled(false);   // æŒ‰é’®ä¸è®©æŒ‰äº†
                Thread thread = new Thread(MainActivity.this);  //åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å»å¹²æ´»
                thread.start();
            }
        });
    }
    
    @Override
    public void run() {
		//do something æ‰§è¡Œä»»åŠ¡
        
        runOnUiThread(new Runnable() {	// æ‰§è¡Œå®Œæ¯•ï¼Œè®©ä¸»çº¿ç¨‹æ›´æ–° UI
            @Override
            public void run() {

            }
        });
    }
}
```



ä¸Šé¢è¿™æ®µä¾‹å­æ˜¯æˆ‘ä» PyTorch å®˜æ–¹çš„åˆ†å‰²å®ä¾‹ä¸­æ‰¾åˆ°çš„ï¼Œå¾ˆæœ‰ä»£è¡¨æ€§ï¼Œé¦–å…ˆåœ¨æˆ‘ä»¬çš„ `onCreate` å‡½æ•°ä¸­å½“æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®çš„æ—¶å€™ï¼Œä»–ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œæ‰§è¡Œä»»åŠ¡çš„å†…å®¹å°±åœ¨ `run()` é‡Œé¢ï¼Œæ‰§è¡Œå®Œäº†ä¹‹åå¦‚æœéœ€è¦æ›´æ–° UI çš„è¯ï¼Œç”¨ `runOnUiThread()` æ–¹æ³•è®©ä¸»çº¿ç¨‹å»æ›´æ–°ã€‚æˆ‘åœ¨ä¸€ä¸ªåšå®¢ä¸­æ‰¾åˆ°çš„è§£é‡Šæ˜¯è¿™æ ·çš„ï¼š

> åœ¨å¼€å‘ Android åº”ç”¨çš„æ—¶å€™æˆ‘ä»¬æ€»æ˜¯è¦è®°ä½åº”ç”¨ä¸»çº¿ç¨‹ã€‚
>
> ä¸»çº¿ç¨‹éå¸¸ç¹å¿™ï¼Œå› ä¸ºå®ƒè¦å¤„ç†ç»˜åˆ¶ UIï¼Œå“åº”ç”¨æˆ·çš„äº¤äº’ï¼Œé»˜è®¤æƒ…å†µä¸‹æ‰§è¡Œæˆ‘ä»¬å†™ä¸‹çš„å¤§éƒ¨åˆ†ä»£ç ã€‚
>
> å¥½çš„å¼€å‘è€…çŸ¥é“ä»–/å¥¹éœ€è¦å°†é‡è´Ÿè·çš„ä»»åŠ¡ç§»é™¤åˆ°å·¥ä½œçº¿ç¨‹é¿å…ä¸»çº¿ç¨‹é˜»å¡ï¼ŒåŒæ—¶è·å¾—æ›´æµç•…çš„ç”¨æˆ·ä½“éªŒï¼Œé¿å… ANR çš„å‘ç”Ÿã€‚
>
> ä½†æ˜¯ï¼Œå½“éœ€è¦æ›´æ–° UI çš„æ—¶å€™æˆ‘ä»¬éœ€è¦â€œè¿”å›â€åˆ°ä¸»çº¿ç¨‹ï¼Œå› ä¸ºåªæœ‰å®ƒæ‰å¯ä»¥æ›´æ–°åº”ç”¨ UIã€‚
>
> æœ€å¸¸ç”¨çš„æ–¹å¼æ˜¯è°ƒç”¨ Activity çš„ `runOnUiThread()` æ–¹æ³•ï¼š





## æ¨¡å‹è½¬æˆ ONNX æ ¼å¼ä»£ç è®°å½•

1. å°† PyTorch è½¬æˆ onnx çš„æ—¶å€™ç”¨ NetRon çœ‹æ¨¡å‹çš„å›¾ç»“æ„æ—¶ä¼šå¾ˆå¤æ‚, å› ä¸º onnx å¯èƒ½å°† PyTorch ä¸­ä¸€ä¸ªå¾ˆç®€å•çš„æ“ä½œå˜æˆä¸€å †å¤æ‚çš„æ“ä½œ,æ¯”å¦‚ä¼šå°† `permute` æ“ä½œå˜æˆä¸€å † `gather`, ä¸æ˜¯å¾ˆæ–¹ä¾¿éƒ¨ç½²,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ `onnx-simplifier` å°†æ¨¡å‹çš„ op ç»™ç®€åŒ–ä¸€ä¸‹,è¿™æ ·å­çš„è¯æˆ‘ä»¬çœ‹åˆ°çš„ op å°±å¾ˆç›´è§‚äº†.
2. å¯¼å‡º onnx æ ¼å¼æ—¶ `opset_version` å‚æ•°è®¾ç½®å¯¼å‡º op çš„ç‰ˆæœ¬,å¤ªé«˜ç‰ˆæœ¬çš„è¯ä¸ä¸€å®šå¥½,æ¯”å¦‚ 11 ä¼šå°† `upsample` æ“ä½œå˜æˆ `resize`,å¯¼è‡´éƒ¨ç½²å›°éš¾,è€Œç”¨ 9 ç‰ˆæœ¬çš„è¯å°±ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜.



```python
model = create_model()

wide = 416

input_names=['input']
output_names=['classification', 'regression']	# æ ¹æ®è‡ªå·±çš„è¾“å‡ºä¸ªæ•°ç¡®å®š

device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
model.to(device)

x = torch.randn((1, 3, wide, wide), requires_grad=True)

try:

    f = "kevin_ckpt/{}_{}_3_{}_{}.onnx".format(model_name, 1, wide, wide)

    torch.onnx.export(model, 
                    x, 
                    f, 
                    verbose=True,	# æ˜¯å¦è¾“å‡ºæ¯ä¸€å±‚çš„ä¿¡æ¯
                    opset_version=11,
                    input_names=input_names,
                    output_names=output_names,
                    dynamic_axes=None)

    # Checks
    model_onnx = onnx.load(f)  # load onnx model
    onnx.checker.check_model(model_onnx)  # check onnx model

    model_onnx = onnx.load(f)  # load onnx model
    model_simp, check = simplify(model_onnx)
    assert check, "Simplified ONNX model could not be validated"
    onnx.save(model_simp, f"{f.split('.')[0]}_sim.onnx")
    print('finished exporting onnx')

except Exception as e:
    logging.info(f'{prefix} export failure: {e}')
```









## reference



[gradleæ’ä»¶ä¸gradleç‰ˆæœ¬å¯¹åº”è¡¨](https://blog.csdn.net/u011897062/article/details/109357551)

[python - urllib.error.HTTPError: HTTP Error 403: rate limit exceeded when loading resnet18 from pytorch hub - Stack Overflow](https://stackoverflow.com/questions/68901236/urllib-error-httperror-http-error-403-rate-limit-exceeded-when-loading-resnet1)

[(beta) Efficient mobile interpreter in Android and iOS â€” PyTorch Tutorials 1.10.0+cu102 documentation](https://pytorch.org/tutorials/recipes/mobile_interpreter.html)

[Android | PyTorchï¼ˆå¿…çœ‹ï¼ï¼‰](https://pytorch.org/mobile/android/#custom-build)

[ç†è§£ Activity.runOnUiThread - ç®€ä¹¦ (jianshu.com)](https://www.jianshu.com/p/e39449026f21)

[ä½¿ç”¨upsampleæ—¶è½¬onnxçš„æ³¨æ„äº‹é¡¹](https://blog.csdn.net/u011622208/article/details/109577710)
